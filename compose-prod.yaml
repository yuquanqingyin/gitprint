services:
  api:
    restart: always
    build:
      context: ./api
    ports:
      - "9701:8080"
    environment:
      - ENV=prod
      - LOG_LEVEL=debug
      - JWT_SECRET=42_bullseye_24_grog
      - GITHUB_CLIENT_ID=Ov23liZEEiOWoR3XtAnt
      - GITHUB_CLIENT_SECRET=ff17f795e218054e8e42bd538566bdf0e181aab9
      - GITHUB_REDIRECT_HOST=https://gitprint.me
      - GITHUB_REPOS_DIR=/root/repos
      - GOTENBERG_ADDR=http://gotenberg:3000
    volumes:
      - ./api/repos:/root/repos

  ui:
    restart: always
    build:
      context: ./ui
      args:
        - NEXT_PUBLIC_API_ADDR=https://api.gitprint.me
    ports:
      - "9702:3000"

  gotenberg:
    restart: always
    image: gotenberg/gotenberg:8
    environment:
      - DEFAULT_WAIT_TIMEOUT=30
    ports:
      - "9703:3000"

  nginx:
    restart: always
    image: nginx:latest
    depends_on:
      - ui
      - api
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    ports:
      - "80:80"
      - "443:443"

  certbot:
    restart: always
    image: certbot/certbot:latest
    volumes:
      - ./conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
